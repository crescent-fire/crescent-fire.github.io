<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Private Kâ€‘Pop Collection</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fafafa;
      color: #111;
    }

    header {
      padding: 16px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 10;
    }

    .cart-indicator {
      position: absolute;
      right: 16px;
      top: 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .notice {
      padding: 12px 16px;
      font-size: 0.8rem;
      color: #555;
      text-align: center;
      background: #fff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      padding: 16px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
    }

    .card img {
      width: 100%;
      border-radius: 10px;
      aspect-ratio: 3 / 4;
      object-fit: cover;
    }

    .title {
      font-size: 0.85rem;
      margin-top: 8px;
      font-weight: 500;
    }

    .price {
      font-size: 0.8rem;
      color: #444;
      margin-top: 4px;
    }

    .status {
      font-size: 0.7rem;
      margin-top: 6px;
      color: green;
    }

    .qty {
      margin-top: 6px;
      font-size: 0.75rem;
    }

    .btn {
      margin-top: 8px;
      padding: 8px;
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid #111;
      background: #fff;
      cursor: pointer;
    }

    /* Cart drawer */
    .cart {
      position: fixed;
      right: 0;
      top: 0;
      height: 100vh;
      width: 100%;
      max-width: 420px;
      background: #fff;
      box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 20;
      display: flex;
      flex-direction: column;
    }

    .cart.open {
      transform: translateX(0);
    }

    .cart-header {
      padding: 16px;
      font-weight: 600;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }

    .cart-items {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
      font-size: 0.8rem;
      margin-bottom: 16px; /* extra margin so last item isnâ€™t hidden */
    }


    .cart-item {
      margin-bottom: 12px;
    }

    .cart-footer {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      border-top: 1px solid #eee;
      background: #fff;
      z-index: 25; /* make sure it stays above items */
    }


    .cart-footer button {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid #111;
      background: #fff;
      font-size: 0.8rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  Private Kâ€‘Pop Collection
  <div class="cart-indicator" onclick="toggleCart()">ðŸ›’ <span id="cartCount">0</span></div>
</header>

<div class="notice">
  Private collection sales. No automatic checkout.<br>
  Items can be reserved or requested to buy.
</div>

<div class="grid" id="productGrid">
  <!-- Cards will be generated dynamically here -->
</div>

<div class="cart" id="cart">
  <div class="cart-header">
    Your selection
    <span onclick="toggleCart()" style="cursor:pointer">âœ•</span>
  </div>
  <div class="cart-items" id="cartItems"></div>
  <div class="cart-footer">
    <div id="cartTotal" style="font-weight:600; margin-bottom:8px;">Total: â‚¬0.00</div>
    <button onclick="openReserveForm()">Reserve items</button>
    <button onclick="openRequestForm()">Request to buy</button>
  </div>
</div>

<script>
  let cart = [];

  function showTempMessage(msg) {
    let notice = document.createElement('div');
    notice.innerText = msg;
    notice.style.position = 'fixed';
    notice.style.bottom = '80px';
    notice.style.left = '50%';
    notice.style.transform = 'translateX(-50%)';
    notice.style.background = 'rgba(0,0,0,0.8)';
    notice.style.color = '#fff';
    notice.style.padding = '10px 16px';
    notice.style.borderRadius = '8px';
    notice.style.zIndex = '999';
    notice.style.fontSize = '0.85rem';
    document.body.appendChild(notice);
  
    setTimeout(() => {
      notice.remove();
    }, 3000); // disappears after 3 seconds
  }

  function addToCart(name, price, btn, availableQty) {
    const qtyToAdd = parseInt(btn.previousElementSibling.value);
  
    // find if item already exists in cart
    const existing = cart.find(item => item.name === name);
  
    if (existing) {
      if (existing.qty + qtyToAdd > availableQty) {
        showTempMessage(`Cannot add more than ${availableQty} of "${name}"`);
        return;
      }
      existing.qty += qtyToAdd;
    } else {
      cart.push({ name, price, qty: qtyToAdd, availableQty });
    }
  
    updateCart();
  }

  function updateCart() {
    const cartCountEl = document.getElementById('cartCount');
    const container = document.getElementById('cartItems');
    container.innerHTML = '';
  
    cartCountEl.innerText = cart.length;
  
    cart.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'cart-item';
  
      // item name
      const nameSpan = document.createElement('span');
      nameSpan.innerText = item.name + ' â€” ';
      div.appendChild(nameSpan);
  
      // quantity selector limited to available stock
      const qtySelect = document.createElement('select');
      for (let q = 1; q <= item.availableQty; q++) {
        const option = document.createElement('option');
        option.value = q;
        option.innerText = q;
        if (q === Number(item.qty)) option.selected = true;
        qtySelect.appendChild(option);
      }
      qtySelect.addEventListener('change', () => {
        item.qty = parseInt(qtySelect.value);
        updateCart();
      });
      div.appendChild(qtySelect);

      // price
      const priceSpan = document.createElement('span');
      priceSpan.innerText = ` â€” â‚¬${(item.price * item.qty).toFixed(2)}`;
      div.appendChild(priceSpan);
  
      // remove button
      const removeBtn = document.createElement('button');
      removeBtn.innerText = 'âœ•';
      removeBtn.style.marginLeft = '8px';
      removeBtn.addEventListener('click', () => {
        cart.splice(i, 1);
        updateCart();
      });

      // calculate total
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.qty;
      });
      document.getElementById('cartTotal').innerText = `Total: â‚¬${total.toFixed(2)}`;

      div.appendChild(removeBtn);
  
      container.appendChild(div);
    });
  }

  function openReserveForm() {
    if (cart.length === 0) {
      alert("Your cart is empty!");
      return;
    }
    const cartItemsString = cart.map(item => `${item.name} Ã— ${item.qty}`).join(', ');
    const url = 'https://docs.google.com/forms/d/e/1FAIpQLScJ3QS9_ZqSyaa5iGHojkhEvwnVDCaQCt17YvdSyHkcxurwiw/viewform?usp=pp_url&entry.989077316='
                + encodeURIComponent(cartItemsString);
    window.open(url, '_blank');
  }
  
  function openRequestForm() {
    if (cart.length === 0) {
      alert("Your cart is empty!");
      return;
    }
    const cartItemsString = cart.map(item => `${item.name} Ã— ${item.qty}`).join(', ');
    const url = 'https://docs.google.com/forms/d/e/1FAIpQLSfOY4xAG_FymrlzgcZb679AQ8vZkOrEt0d4KSbVGcS_3N11nw/viewform?usp=pp_url&entry.1451513929='
                + encodeURIComponent(cartItemsString);
    window.open(url, '_blank');
  }

  function toggleCart() {
    document.getElementById('cart').classList.toggle('open');
  }
</script>
  
<script>
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSOm_vXFesEFHehCK5RGPp9f_H0tGry3CS85NMVWMJpFBtjH8XqUSfj_W--B267VztKfgEXIw1URvNG/pub?gid=0&single=true&output=csv'; // your published CSV link
  
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines.shift().match(/(?:\"([^\"]*(?:\"\"[^\"]*)*)\")|([^,]+)/g).map(h => h.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
  
    return lines.map(line => {
      const matches = line.match(/(?:\"([^\"]*(?:\"\"[^\"]*)*)\")|([^,]+)/g);
      const obj = {};
      headers.forEach((header, i) => {
        let val = matches[i] || '';
        val = val.replace(/^"|"$/g,'').replace(/""/g,'"').trim();
        obj[header] = val;
      });
      return obj;
    });
  }


  async function generateProducts() {
    try {
      const res = await fetch(sheetUrl);
      const text = await res.text();
  
      const data = parseCSV(text);

      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
  
      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `product-${item.ID}`;
  
        const img = document.createElement('img');
        let photoURL = item['Photo URL'] ? item['Photo URL'].trim() : '';
        img.src = photoURL.startsWith('http') ? photoURL : 'https://via.placeholder.com/300';
        img.alt = item.Name;
        card.appendChild(img);
  
        const title = document.createElement('div');
        title.className = 'title';
        title.innerText = item.Name;
        card.appendChild(title);
  
        const price = document.createElement('div');
        price.className = 'price';
        price.innerText = `â‚¬${item['Price (â‚¬)']}`;
        card.appendChild(price);
  
        const status = document.createElement('div');
        status.className = 'status';
        status.innerText = item.Status || 'Available';
        card.appendChild(status);
  
        // quantity selector
        const select = document.createElement('select');
        select.className = 'qty';
        const totalQty = parseInt(item.Quantity) || 0;
        const reservedQty = parseInt(item['Reserved Quantity']) || 0;
        const availableQty = Math.max(totalQty - reservedQty, 0);
        for (let i = 1; i <= availableQty; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.innerText = `Qty: ${i}`;
          select.appendChild(option);
        }
        card.appendChild(select);
  
        // add to cart button
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerText = 'Add to cart';
        btn.onclick = () =>
          addToCart(
            item.Name,
            parseFloat(item['Price (â‚¬)']),
            btn,
            availableQty
          );
        if ((item.Status || 'Available').toLowerCase() !== 'available') {
          btn.disabled = true;
          status.style.color = item.Status.toLowerCase() === 'sold' ? 'red' : 'orange';
        }
        card.appendChild(btn);
  
        grid.appendChild(card);

        if (availableQty === 0) {
          btn.disabled = true;
          status.innerText = 'Reserved';
          status.style.color = 'orange';
        }

      });
  
    } catch (err) {
      console.error('Failed to fetch inventory:', err);
    }
  }
  
  // run immediately
  generateProducts();
  // refresh every 60 seconds
  setInterval(generateProducts, 60000);
</script>
  
</body>
</html>
